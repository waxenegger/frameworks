!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.glue=t():(e.ome=e.ome||{},e.ome.glue=t())}(this,function(){return function(e){function t(n){if(r[n])return r[n].exports;var o=r[n]={exports:{},id:n,loaded:!1};return e[n].call(o.exports,o,o.exports,t),o.loaded=!0,o.exports}var r={};return t.m=e,t.c=r,t.p="",t(0)}([function(e,t,r){"use strict";var n=r(1),o=r(4),s=r(3);n.WebGlue=function(){this.events_=new o.EventBus,this.data_=new s.DataStore},n.WebGlue.prototype.publish=function(e,t,r){this.events_.publish(e,t,r)},n.WebGlue.prototype.subscribe=function(e,t,r){this.events_.subscribe(e,t,r)},n.WebGlue.prototype.unsubscribe=function(e,t){this.events_.unsubscribe(e,t)},n.WebGlue.prototype.request=function(e,t,r){this.data_.requestData(e,t,r)},n.WebGlue.prototype.getDataStore=function(){return this.data_},e.exports=n},function(e,t){"use strict";var r={};r.EVENTS={IMAGE_CHANGE:{event:"image_change",properties:[{name:"id",type:"number"}]},IMAGE_DIMENSION_CHANGE:{event:"image_dimension_change",properties:[{name:"id",type:"number"},{name:"dim",type:"string"},{name:"value",type:"array"}]},IMAGE_SHOW_REGIONS:{event:"image_dimension_change",properties:[{name:"id",type:"number"},{name:"dim",type:"string"},{name:"value",type:"array"}]},IMAGE_INIT_REGIONS:{event:"image_init_regions",properties:[{name:"id",type:"number"}]},IMAGE_VISIBILITY_REGIONS:{event:"image_visibility_regions",properties:[{name:"id",type:"number"},{name:"visible",type:"boolean"},{name:"roi_shape_ids",type:"array"}]}},e.exports=r},function(e,t,r){"use strict";var n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},o=r(1);o.utils={},o.utils.isArray=function(e){return"object"!==("undefined"==typeof e?"undefined":n(e))||null===e?!1:e instanceof Array||"[object Array]"===Object.prototype.toString.call(null,e)},o.utils.ajax=function(e){if("object"!==("undefined"==typeof e?"undefined":n(e))||o.utils.isArray(e))throw Error("Cannot send ajax request without request parameters!");if("string"!=typeof e.url||0===e.url.length)throw Error("Cannot send ajax request without a non-empty url!");if("function"!=typeof e.success)throw Error("Don't want to send ajax request without success handler. What's the point...");if("string"==typeof e.method&&(e.method="GET"),e.method=e.method.toUpperCase(),"GET"!==e.method&&"POST"!==e.method&&"PUT"!==e.method&&"DELETE"!==e.method&&"HEAD"!==e.method)throw Error("Request property method can only be GET,PUT, POST, HEAD or DELETE");return"string"==typeof e.dataType&&0!==e.dataType.length||(e.dataType="json"),e.dataType=e.dataType.toLowerCase(),("object"!==n(e.context)||o.utils.isArray(e.context))&&(e.context=this),("object"!==n(e.headers)||o.utils.isArray(e.headers))&&(e.headers={}),"string"!=typeof e.data&&(e.data=null),"number"!=typeof e.timeout&&(e.timeout=6e4),"function"!=typeof e.error&&(e.error=function(e){console.error(e)}),"jsonp"===e.dataType?void o.utils.sendJsonpRequest(e):void o.utils.sendAjaxRequest(e)},o.utils.sendAjaxRequest=function(e){var t="undefined"!=typeof window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),r=e.url;if("GET"===e.method&&"boolean"==typeof e.cache&&e.cache){var s="_"+(new Date).getTime();r+=-1===e.url.indexOf("?")?"?"+s:"&"+s}t.open(e.method,r,!0);var i="object"===n(e.headers)?e.headers:{},a=o.utils.getCookie("csrftoken");""!==a&&(i["X-CSRFToken"]=a);for(h in i)t.setRequestHeader(h,i[h]);t.timeout=e.timeout,t.ontimeout=function(){console.info("xhr request timed out!")},t.onerror=function(t){var r="undefined"!=typeof t.target?t.target.responseText:null,n=null===r?"xhr: an error occured":"xhr error: "+r;e.error(n)},t.onreadystatechange=function(r){if(4==t.readyState&&t.status>=200&&t.status<300){var n=t.responseText;if("undefined"==typeof n&&(n=null),null!==n){var o="webclient/login/?url=",s="string"==typeof t.responseURL,i=s?t.responseURL.lastIndexOf(o):t.responseText.lastIndexOf(o);if(-1!==i){var a=o,u=window.location.href;return s&&(a=t.responseURL.substring(0,i+o.length)),window.location.href=a+u,!0}e.success.call(e.context,n)}else e.error.call(e.context,t.statusText);return!0}return 4==t.readyState?(e.error.call(e.context,t.statusText),!0):!1},t.send("POST"===e.method?e.data:null)},o.utils.sendJsonpRequest=function(e){function t(t){try{var n=document.head,s=document.createElement("script");s.onerror=function(t){console.error("JSONP request failed!"),e.error.call(e.context,t),delete o[r]},s.src=t,n.appendChild(s),n.removeChild(s)}catch(i){console.error("failed to setup jsonp request: "+i)}}var r="jsonpCallback_"+(new Date).getTime();window[r]=function(t){try{"function"==typeof e.success&&e.success.call(e.context,t)}catch(n){console.error("Caught exception executing success handler: "+n)}delete o[r]};try{var n=e.url;n+=-1===e.url.indexOf("?")?"?":"&",t(n+"callback=window."+r)}catch(s){console.error("jsonp: failed to issue request: "+s)}},o.utils.getCookie=function(e){if("string"!=typeof e)return"";for(var t=document.cookie.split(";"),r=0,n=t.length;n>r;r++){for(var o=t[r];" "==o.charAt(0);)o=o.substring(1);if(0==o.indexOf(e+"="))return o.substring(e.length+1,o.length)}return""},e.exports=o.utils},function(t,r,n){"use strict";var o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},s=n(1),i=n(2);s.DataStore=function(){this.data_store_={},this.updateTask_=null,this.ajax_="undefined"!=typeof jQuery&&"function"==typeof jQuery.ajax?jQuery.ajax:null,null===this.ajax_&&("undefined"!=typeof $&&"function"==typeof $.ajax?this.ajax_=$.ajax:this.ajax_=i.ajax),setTimeout(function(e){e.startUpdateTask(3e5)},6e4,this)},s.DataStore.prototype.makeAjaxRequest=function(e,t,r){if("boolean"!=typeof r&&(r=!1),!r||!e||e.update){var n=t.success;t.success=function(r,o,s){var i="undefined"!=typeof t.context?t.context:null;e&&(e.status="success",e.response=r,e.fails=0);try{n.call(i,r,"undefined"!=typeof o?o:null,"undefined"!=typeof s?s:null)}finally{n=null,delete t.success,delete t.error,delete t.context}};var o="function"==typeof t.error?t.error:null;t.error=function(n,s,i){var a="undefined"!=typeof t.context?t.context:null;!r&&e&&(e.status="error",i instanceof Error?e.response=i.stack:"string"==typeof i?e.response=i:"string"==typeof s?e.response=s:e.response=n.statusText),r&&e&&e.fails++;try{o&&o.call(a,n,"undefined"!=typeof s?s:null,"undefined"!=typeof i?i:null)}finally{o=null,delete t.success,delete t.error,delete t.context}},this.ajax_(t)}},s.DataStore.prototype.requestData=function(e,t,r){if("object"!==("undefined"==typeof e?"undefined":o(e))||i.isArray(e))throw Error("requestData needs an ajax propeties object like jquery uses!");if("string"!=typeof e.url||0===e.url.length||"function"!=typeof e.success)throw Error("requestData needs an ajax properties object with a url and a success handler at a minimum!");"string"==typeof e.method&&0!==e.method.length||(e.method="GET");var n=i.getCookie("csrftoken");""!==n&&("object"!==o(e.headers)&&(e.headers={}),e.headers["X-CSRFToken"]=n),t="boolean"==typeof t?t:!0,r="boolean"==typeof r?r:!1,setTimeout(function(n){s.DataStore.prototype.request0.call(n,e,t,r)},0,this)},s.DataStore.prototype.request0=function(e,t,r){if("string"==typeof e.method&&("POST"===e.method.toUpperCase()||"PUT"===e.method.toUpperCase()||"DELETE"===e.method.toUpperCase()))return e.cache=!1,void this.makeAjaxRequest(this.data_store_[e.url],e);if(r?e.cache=!1:e.cache=!0,"object"!==o(this.data_store_[e.url])||i.isArray(this.data_store_[e.url])||"string"==typeof this.data_store_[e.url].status&&"error"===this.data_store_[e.url].status.toLowerCase()||r)this.data_store_[e.url]={status:"pending",time:(new Date).getTime(),response:null,properties:e,fails:0,update:t},this.makeAjaxRequest(this.data_store_[e.url],e);else if("success"===this.data_store_[e.url].status){var n="undefined"!=typeof e.context?e.context:null;e.success.call(n,this.data_store_[e.url].response)}else if("pending"===this.data_store_[e.url].status){var s=this.data_store_[e.url],a=(new Date).getTime()-s.time;if(5e3>a){var u=(new Date).getTime(),c=setInterval(function(t){try{(new Date).getTime()-u>2e3&&(t.makeAjaxRequest(s,e),clearInterval(c));var r=!1;"success"===s.status?(e.success(s.response),r=!0):"error"===s.status&&("function"==typeof e.error&&e.error(s.response),r=!0),r&&clearInterval(c)}catch(n){clearInterval(c)}},10,this);return}this.makeAjaxRequest(this.data_store_[e.url],e)}},s.DataStore.prototype.listDataStoreKeys=function(){var t=[];for(e in this.data_store_)t.push(e);return t},s.DataStore.prototype.queryDataStore=function(e,t){if("string"!=typeof e&&e.length>0)return null;if("string"==typeof t&&0!==t.length||(t=""),t=t.toLowerCase(),"status"!==t&&"response"!==t&&"time"!=t&&"properties"!=t&&"fails"!=t&&"update"!=t&&(t=""),"undefined"==typeof this.data_store_[e])return null;var r={};if(""===t)return this.data_store_[e];var r={};return r[t]=this.data_store_[e][t],r},s.DataStore.prototype.clearDataStore=function(){this.data_store_={}},s.DataStore.prototype.startUpdateTask=function(e){("number"!=typeof e||6e4>=e)&&(e=6e4),this.stopUpdateTask(),this.updateTask_=setInterval(function(e){var t=e.listDataStoreKeys();for(var r in t)try{var n=e.data_store_[t[r]];if(n.fails>5){e.data_store_[t[r]]=null,delete e.data_store_[t[r]];continue}if(properties={},"object"===o(n.properties)&&null!==n.properties)for(var s in n.properties)properties[s]=n.properties[s];properties.cache=!1;var i=(new Date).getTime();properties.success=function(e){n.time=i},properties.error=function(){},e.makeAjaxRequest(n,properties,!0)}catch(a){}},e,this)},s.DataStore.prototype.stopUpdateTask=function(){this.updateTask_&&clearInterval(this.updateTask_),this.updateTask_=null},t.exports=s},function(e,t,r){"use strict";var n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},o=r(1),s=r(2);o.EventBus=function(){this.uid_=0,this.events_={},this.subscribers_={}},o.EventBus.prototype.getNextUid=function(e){return"string"!==e&&(e="uid_"),e+ ++this.uid_},o.EventBus.prototype.getOrSetSubscriberUid=function(e){return"object"!==("undefined"==typeof e?"undefined":n(e))||s.isArray(e)||null===e?null:("string"==typeof e.subscriber_uid&&0!==e.subscriber_uid.length||(e.subscriber_uid=this.getNextUid("subscriber_")),e.subscriber_uid)},o.EventBus.prototype.hasSubscribed=function(e){if("object"!==("undefined"==typeof e?"undefined":n(e))||s.isArray(e)||null===e)return null;var t=this.getOrSetSubscriberUid(e);return null===t||"object"!==n(this.subscribers_[t])||s.isArray(this.subscribers_[t])?null:t},o.EventBus.prototype.hasSubscribedForEvent=function(e,t){var r=this.hasSubscribed(e);if(null===r)return!1;var n=this.subscribers_[r];for(var o in n)if(t.toLowerCase()===o)return!0;return!1},o.EventBus.prototype.checkEventData=function(e,t){if("undefined"!=typeof e.properties&&s.isArray(e.properties))for(var r in e.properties){var o=e.properties[r];if("string"!=typeof o.name)return console.error("Propery name can only be a string!"),!1;if("undefined"==typeof t[o.name]||"string"==typeof o.type&&"array"===o.type.toLowerCase()&&!s.isArray(t[o.name])||"string"==typeof o.type&&"array"!==o.type.toLowerCase()&&n(t[o.name])!==o.type.toLowerCase())return console.error("Data format violates definition for property: "+o.name),!1}return!0},o.EventBus.prototype.publish=function(e,t,r){var o=null;if("object"===("undefined"==typeof e?"undefined":n(e))&&!s.isArray(e)&&"string"==typeof e.event&&e.event.length>0?o=e.event:"string"==typeof e&&e.length>0&&(o=e),null===o)throw Error("call publish with arguments: event(string or predefined object) and, optionally: data(Object)");if("object"!==("undefined"==typeof e?"undefined":n(e))||"undefined"==typeof t||null===t||this.checkEventData(e,t)){var i="string"==typeof r?r:this.getNextUid("webglue_uid_"),a="object"===("undefined"==typeof t?"undefined":n(t))&&t?t:{},u=(new Date).getTime();if(o=o.toLowerCase(),s.isArray(this.events_[o]))for(var c in this.events_[o]){var l=this.events_[o][c];l.callback.call(l.context,a,i,u)}}},o.EventBus.prototype.subscribe=function(e,t,r){var o=null;if("object"===("undefined"==typeof e?"undefined":n(e))&&!s.isArray(e)&&"string"==typeof e.event&&e.event.length>0?o=e.event:"string"==typeof e&&e.length>0&&(o=e),null===o||"function"!=typeof t||"undefined"==typeof r||null===r)throw Error("call subscribe with arguments: event(string or predefined object),callback(function), context(object instance subscribing)!");var i=this.getOrSetSubscriberUid(r);if(null===this.hasSubscribed(r)&&(this.subscribers_[i]={}),!this.hasSubscribedForEvent(r,o)){var a=function(){var e=[],n=null,o=arguments.length;if(o>0)for(var s=0;o>s;s++)e.push(arguments[s]),1===s&&"string"==typeof arguments[s]&&(n=arguments[s]);n&&n===i||setTimeout(function(){t.apply("undefined"!=typeof r&&r?r:this,e)},0)},e=o.toLowerCase();s.isArray(this.events_[e])||(this.events_[e]=[]),this.events_[e].push({callback:a,context:r,sub_uid:i}),this.subscribers_[i][e]=!0}},o.EventBus.prototype.unsubscribe=function(e,t){if("undefined"==typeof e||null===e)throw Error("call unsubscribe with arguments: subscriber(object instance) and, optionally, event type(string)!");var r="string"==typeof t&&t.length>0?t.toLowerCase():null;for(var n in this.events_){var o=this.events_[n];if(!r||r===n)for(var s in o)e.subscriber_uid===this.events_[n][s].sub_uid&&(o=o.splice(parseInt(s),1))}var i=this.subscribers_[e.subscriber_uid];if(null===r)return i=null,void delete this.subscribers_[e.subscriber_uid];for(n in i)if("undefined"!=typeof i[n]&&n===r){delete i[n];break}},e.exports=o}])});